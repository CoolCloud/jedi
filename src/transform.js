'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
	value: true
});
exports['default'] = transform;

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _util2 = require('./util2');

var _fs = require('fs');

var _ = require('.');

var _util = require('./util');

var _transformer = require('./transformer');

var _transformer2 = _interopRequireDefault(_transformer);

var debug = (0, _debug2['default'])('transform');

function transformImport(document) {
	var _context;

	return (_context = _util2.traverse.call(document, function (node) {
		var _context2;

		var nodeType = node.nodeType;

		var _node$position = _slicedToArray(node.position, 1);

		var path = _node$position[0];

		if (nodeType !== 'document') throw new Error();
		node.childNodes = (_context2 = node.childNodes, _util2.traverse).call(_context2, function (_ref) {
			var nodeType = _ref.nodeType;
			var position = _ref.position;

			if (nodeType !== 'skip' && position.length === 2) position.unshift(path);
		}, undefined, true);
		return false;
	}), _util2.traverse).call(_context, function (node) {
		var nodeType = node.nodeType;

		var _node$position2 = _slicedToArray(node.position, 1);

		var path = _node$position2[0];
		var nodeName = node.nodeName;
		var nodeValue = node.nodeValue;
		var childNodes = node.childNodes;

		if (nodeType === 'instruction' && nodeName === 'import') {
			var tree = loadTree((0, _util2.resolve)(nodeValue, path));
			tree = override(tree, childNodes);
			_Object$assign(node, tree);
		}
	}, 'post');
}

function sortNodes(tree) {
	return _util2.traverse.call(tree, function (node) {
		if (node.childNodes) {
			var _context3;

			(function () {
				var attributes = [],
				    macros = [],
				    normalNodes = [];
				var skips = [];
				var flush = function flush(to) {
					if (skips.length > 0) {
						to.push.apply(to, _toConsumableArray(skips));
						skips = [];
					}
				};
				(_context3 = node.childNodes, _util2.traverse).call(_context3, function (node) {
					switch (node.nodeType) {
						case 'skip':
						case 'suppress':
						case 'inject':
							skips.push(node);
							break;
						case 'attribute':
							flush(attributes);
							attributes.push(node);
							break;
						case 'macro':
							flush(macros);
							macros.push(node);
							break;
						default:
							flush(normalNodes);
							normalNodes.push(node);
							break;
					}
					return false;
				}, undefined, true);
				flush(normalNodes);
				var sorted = macros.concat(normalNodes);
				if (node.nodeType === 'element' || node.nodeType === 'macro') {
					sorted.unshift.apply(sorted, attributes.concat([{ nodeType: 'skip', data: ['closeStartTag'] }]));
				} else if (attributes.length > 0) {
					var e = new Error('OnlyElementAllowAttribute');
					e.position = attributes[0].position;
					throw e;
				}
				node.childNodes = sorted.map(_util2.record2tuple);
			})();
		}
	}, 'post');
}

function loadTree(name) {
	var path = undefined,
	    frag = undefined;
	var i = name.lastIndexOf('#');
	if (i >= 0) {
		path = name.slice(0, i);
		frag = name.slice(i + 1);
	} else path = name;

	if ((0, _fs.existsSync)(path + '.jedi')) path += '.jedi';
	var tree = (0, _.parseFile)(path);
	tree = transformImport(tree);
	if (!frag) {
		tree[0] = 'fragment';
		tree[2] = name + '#';
		return tree;
	}
	tree = _util2.query.call(tree, function (_ref2) {
		var nodeType = _ref2.nodeType;
		var nodeName = _ref2.nodeName;
		var nodeValue = _ref2.nodeValue;
		var id = _ref2.id;
		return nodeType === 'fragment' && nodeName === frag && nodeValue === undefined || nodeType === 'element' && id === frag;
	});
	if (!tree) throw new Error('Failed to load ' + name);
	tree[2] = name;
	return tree;
}

function transform(tree) {
	var show = arguments.length <= 1 || arguments[1] === undefined ? [] : arguments[1];

	if (show[0]) (0, _util.dir)(tree);

	console.time('transform 1');
	tree = transformImport(tree);
	console.timeEnd('transform 1');
	if (show[1]) (0, _util.dir)(tree);

	console.time('transform 2');
	tree = _transformer2['default'].ScriptIIFEWrapper.match(tree, 'document');
	console.timeEnd('transform 2');
	if (show[2]) (0, _util.dir)(tree);

	console.time('transform 3');
	tree = sortNodes(tree);
	console.timeEnd('transform 3');
	if (show[3]) (0, _util.dir)(tree);

	return tree;
}

function override(template, blocks) {
	var _context4;

	blocks = blocks.map(_util2.tuple2record);
	var contentFragment = undefined;

	var tpl = (0, _util2.tuple2record)(template);
	(_context4 = tpl.childNodes, _util2.traverse).call(_context4, function (node) {

		var frag = undefined;
		if (node.nodeType === 'fragment' && node.nodeValue === undefined) {
			frag = node.nodeName;
		} else if (node.nodeType === 'element' && node.id) {
			frag = node.id;
		} else if (node.nodeType === 'macro') {
			return false;
		}
		if (frag) {
			var frags = { replace: undefined, befores: [], afters: [], rest: [] };
			frags = blocks.reduce(matchesFragment(frag), frags);
			blocks = frags.rest;
			if (frags.replace) {
				var _node$childNodes;

				(_node$childNodes = node.childNodes).splice.apply(_node$childNodes, [0, Infinity].concat(_toConsumableArray(frags.replace.childNodes)));
			} else if (frag === 'content') {
				contentFragment = node;
			}
			if (frags.befores.length > 0) {
				var _node$childNodes2;

				var i = node.childNodes.findIndex(function (child) {
					var _tuple2record = (0, _util2.tuple2record)(child);

					var nodeType = _tuple2record.nodeType;
					var nodeName = _tuple2record.nodeName;
					var nodeValue = _tuple2record.nodeValue;

					return nodeType !== 'fragment' || nodeName !== frag || nodeValue !== 'before';
				});
				(_node$childNodes2 = node.childNodes).splice.apply(_node$childNodes2, [0, i].concat(_toConsumableArray(frags.befores.map(_util2.record2tuple))));
			}
			if (frags.afters.length > 0) {
				var _node$childNodes3;

				var last = undefined;
				while (true) {
					last = node.childNodes.pop();

					var _tuple2record2 = (0, _util2.tuple2record)(last);

					var nodeType = _tuple2record2.nodeType;
					var nodeName = _tuple2record2.nodeName;
					var nodeValue = _tuple2record2.nodeValue;

					if (!(nodeType === 'fragment' && nodeName === frag && nodeValue === 'after')) break;
				}
				(_node$childNodes3 = node.childNodes).push.apply(_node$childNodes3, [last].concat(_toConsumableArray(frags.afters.map(_util2.record2tuple))));
			}
			return false;
		}
	});
	if (contentFragment) {
		var _contentFragment$childNodes;

		(_contentFragment$childNodes = contentFragment.childNodes).splice.apply(_contentFragment$childNodes, [0, Infinity].concat(_toConsumableArray(blocks.map(_util2.record2tuple))));
		debug('replace default content to', blocks, contentFragment.childNodes);
	}

	return tpl;
}

function matchesFragment(fragName) {
	return function (result, node) {
		var befores = result.befores;
		var afters = result.afters;
		var rest = result.rest;

		if (node.nodeType !== 'fragment' || node.nodeName !== fragName) rest.push(node);else {
			switch (node.nodeValue) {
				case 'before':
					befores.push(node);break;
				case 'after':
					afters.push(node);break;
				default:
					result.replace = node //TODO: throw error if multiple replacement
					;}
		}
		return result;
	};
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyYW5zZm9ybS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O3FCQWtHd0IsU0FBUzs7cUJBbEdmLE9BQU87Ozs7cUJBRzBDLFNBQVM7O2tCQW1FbkQsSUFBSTs7Z0JBQ0wsR0FBRzs7b0JBeUJULFFBQVE7OzJCQUNGLGVBQWU7Ozs7QUFoR3ZDLElBQU0sS0FBSyxHQUFHLHdCQUFNLFdBQVcsQ0FBQyxDQUFBOztBQUdoQyxTQUFTLGVBQWUsQ0FBQyxRQUFRLEVBQUU7OztBQUNsQyxRQUFPLFlBQUEsT0FGNEIsUUFBUSxNQUVwQyxRQUFRLEVBQVcsVUFBQSxJQUFJLEVBQUk7OztNQUMxQixRQUFRLEdBQXNCLElBQUksQ0FBbEMsUUFBUTs7c0NBQXNCLElBQUksQ0FBeEIsUUFBUTs7TUFBRyxJQUFJOztBQUNoQyxNQUFJLFFBQVEsS0FBSyxVQUFVLEVBQUUsTUFBTSxJQUFJLEtBQUssRUFBRSxDQUFBO0FBQzlDLE1BQUksQ0FBQyxVQUFVLEdBQUcsYUFBQSxJQUFJLENBQUMsVUFBVSxTQUxDLFFBQVEsa0JBS0UsVUFBQyxJQUFvQixFQUFLO09BQXhCLFFBQVEsR0FBVCxJQUFvQixDQUFuQixRQUFRO09BQUUsUUFBUSxHQUFuQixJQUFvQixDQUFULFFBQVE7O0FBQy9ELE9BQUksUUFBUSxLQUFLLE1BQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO0dBQ3hFLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFBO0FBQ25CLFNBQU8sS0FBSyxDQUFBO0VBQ1osQ0FBQyxTQVRpQyxRQUFRLGlCQVM5QixVQUFBLElBQUksRUFBSTtNQUNiLFFBQVEsR0FBdUQsSUFBSSxDQUFuRSxRQUFROzt1Q0FBdUQsSUFBSSxDQUF6RCxRQUFROztNQUFHLElBQUk7TUFBRyxRQUFRLEdBQTJCLElBQUksQ0FBdkMsUUFBUTtNQUFFLFNBQVMsR0FBZ0IsSUFBSSxDQUE3QixTQUFTO01BQUUsVUFBVSxHQUFJLElBQUksQ0FBbEIsVUFBVTs7QUFDbEUsTUFBSSxRQUFRLEtBQUssYUFBYSxJQUFJLFFBQVEsS0FBSyxRQUFRLEVBQUU7QUFDeEQsT0FBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLFdBWnVCLE9BQU8sRUFZdEIsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUE7QUFDN0MsT0FBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDakMsa0JBQWMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO0dBQ3pCO0VBQ0QsRUFBRSxNQUFNLENBQUMsQ0FBQTtDQUNWOztBQUVELFNBQVMsU0FBUyxDQUFDLElBQUksRUFBRTtBQUN4QixRQUFPLE9BcEI0QixRQUFRLE1Bb0JwQyxJQUFJLEVBQVcsVUFBQSxJQUFJLEVBQUk7QUFDN0IsTUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFOzs7O0FBQ3BCLFFBQU0sVUFBVSxHQUFHLEVBQUU7UUFBRSxNQUFNLEdBQUcsRUFBRTtRQUFFLFdBQVcsR0FBRyxFQUFFLENBQUE7QUFDcEQsUUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFBO0FBQ2QsUUFBTSxLQUFLLEdBQUcsU0FBUixLQUFLLENBQUcsRUFBRSxFQUFJO0FBQ25CLFNBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7QUFDckIsUUFBRSxDQUFDLElBQUksTUFBQSxDQUFQLEVBQUUscUJBQVMsS0FBSyxFQUFDLENBQUE7QUFDakIsV0FBSyxHQUFHLEVBQUUsQ0FBQTtNQUNWO0tBQ0QsQ0FBQTtBQUNELGlCQUFBLElBQUksQ0FBQyxVQUFVLFNBOUJrQixRQUFRLGtCQThCZixVQUFBLElBQUksRUFBSTtBQUNqQyxhQUFRLElBQUksQ0FBQyxRQUFRO0FBQ3BCLFdBQUssTUFBTSxDQUFDO0FBQ1osV0FBSyxVQUFVLENBQUM7QUFDaEIsV0FBSyxRQUFRO0FBQ1osWUFBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNoQixhQUFLO0FBQUEsQUFDTixXQUFLLFdBQVc7QUFDZixZQUFLLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDakIsaUJBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDckIsYUFBSztBQUFBLEFBQ04sV0FBSyxPQUFPO0FBQ1gsWUFBSyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0FBQ2IsYUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNqQixhQUFLO0FBQUEsQUFDTjtBQUNDLFlBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQTtBQUNsQixrQkFBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUN0QixhQUFLO0FBQUEsTUFDTjtBQUNELFlBQU8sS0FBSyxDQUFBO0tBQ1osRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUE7QUFDbkIsU0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ2xCLFFBQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDekMsUUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLE9BQU8sRUFBRTtBQUM3RCxXQUFNLENBQUMsT0FBTyxNQUFBLENBQWQsTUFBTSxFQUFZLFVBQVUsU0FBRSxFQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsZUFBZSxDQUFDLEVBQUMsR0FBQyxDQUFBO0tBQzFFLE1BQU0sSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUNqQyxTQUFNLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFBO0FBQ2hELE1BQUMsQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQTtBQUNuQyxXQUFNLENBQUMsQ0FBQTtLQUNQO0FBQ0QsUUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsR0FBRyxRQTdEVCxZQUFZLENBNkRXLENBQUE7O0dBQzFDO0VBQ0QsRUFBRSxNQUFNLENBQUMsQ0FBQTtDQUNWOztBQUtELFNBQVMsUUFBUSxDQUFDLElBQUksRUFBRTtBQUN2QixLQUFJLElBQUksWUFBQTtLQUFFLElBQUksWUFBQSxDQUFBO0FBQ2QsS0FBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUMvQixLQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7QUFDWCxNQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFDdkIsTUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0VBQ3hCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQTs7QUFFbEIsS0FBSSxRQVZHLFVBQVUsRUFVRixJQUFJLEdBQUcsT0FBTyxDQUFDLEVBQUUsSUFBSSxJQUFJLE9BQU8sQ0FBQTtBQUMvQyxLQUFJLElBQUksR0FBRyxNQVZKLFNBQVMsRUFVSyxJQUFJLENBQUMsQ0FBQTtBQUMxQixLQUFJLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQzVCLEtBQUksQ0FBQyxJQUFJLEVBQUU7QUFDVixNQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFBO0FBQ3BCLE1BQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFBO0FBQ3BCLFNBQU8sSUFBSSxDQUFBO0VBQ1g7QUFDRCxLQUFJLEdBQUcsT0FyRitDLEtBQUssTUFxRnBELElBQUksRUFBUSxVQUFDLEtBQW1DO01BQWxDLFFBQVEsR0FBVCxLQUFtQyxDQUFsQyxRQUFRO01BQUUsUUFBUSxHQUFuQixLQUFtQyxDQUF4QixRQUFRO01BQUUsU0FBUyxHQUE5QixLQUFtQyxDQUFkLFNBQVM7TUFBRSxFQUFFLEdBQWxDLEtBQW1DLENBQUgsRUFBRTtTQUNyRCxRQUFRLEtBQUssVUFBVSxJQUFJLFFBQVEsS0FBSyxJQUFJLElBQUksU0FBUyxLQUFLLFNBQVMsSUFDcEUsUUFBUSxLQUFLLFNBQVMsSUFBSSxFQUFFLEtBQUssSUFBSTtFQUFBLENBQUMsQ0FBQTtBQUMxQyxLQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLENBQUE7QUFDcEQsS0FBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQTtBQUNkLFFBQU8sSUFBSSxDQUFBO0NBQ1g7O0FBSWMsU0FBUyxTQUFTLENBQUMsSUFBSSxFQUFhO0tBQVgsSUFBSSx5REFBRyxFQUFFOztBQUNoRCxLQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUhOLEdBQUcsRUFHTyxJQUFJLENBQUMsQ0FBQTs7QUFFdEIsUUFBTyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUMzQixLQUFJLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQzVCLFFBQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUE7QUFDOUIsS0FBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFSTixHQUFHLEVBUU8sSUFBSSxDQUFDLENBQUE7O0FBRXRCLFFBQU8sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUE7QUFDM0IsS0FBSSxHQUFHLHlCQUFZLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDNUQsUUFBTyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUM5QixLQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxVQWJOLEdBQUcsRUFhTyxJQUFJLENBQUMsQ0FBQTs7QUFFdEIsUUFBTyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUMzQixLQUFJLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ3RCLFFBQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUE7QUFDOUIsS0FBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFsQk4sR0FBRyxFQWtCTyxJQUFJLENBQUMsQ0FBQTs7QUFFdEIsUUFBTyxJQUFJLENBQUE7Q0FDWDs7QUFFRCxTQUFTLFFBQVEsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFOzs7QUFFbkMsT0FBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLFFBdEhaLFlBQVksQ0FzSGMsQ0FBQTtBQUNqQyxLQUFJLGVBQWUsWUFBQSxDQUFBOztBQUVuQixLQUFNLEdBQUcsR0FBRyxXQXpITCxZQUFZLEVBeUhNLFFBQVEsQ0FBQyxDQUFBO0FBQ2xDLGNBQUEsR0FBRyxDQUFDLFVBQVUsU0ExSHFCLFFBQVEsa0JBMEhsQixVQUFBLElBQUksRUFBSTs7QUFFaEMsTUFBSSxJQUFJLFlBQUEsQ0FBQTtBQUNSLE1BQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxVQUFVLElBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUU7QUFDakUsT0FBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUE7R0FDcEIsTUFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssU0FBUyxJQUFJLElBQUksQ0FBQyxFQUFFLEVBQUU7QUFDbEQsT0FBSSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUE7R0FDZCxNQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxPQUFPLEVBQUU7QUFDckMsVUFBTyxLQUFLLENBQUE7R0FDWjtBQUNELE1BQUksSUFBSSxFQUFFO0FBQ1QsT0FBSSxLQUFLLEdBQUcsRUFBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFDLENBQUE7QUFDbkUsUUFBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFBO0FBQ25ELFNBQU0sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFBO0FBQ25CLE9BQUksS0FBSyxDQUFDLE9BQU8sRUFBRTs7O0FBQ2xCLHdCQUFBLElBQUksQ0FBQyxVQUFVLEVBQUMsTUFBTSxNQUFBLG9CQUFDLENBQUMsRUFBRSxRQUFRLDRCQUFLLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFDLENBQUE7SUFDaEUsTUFBTSxJQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7QUFDOUIsbUJBQWUsR0FBRyxJQUFJLENBQUE7SUFDdEI7QUFDRCxPQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs7O0FBQzdCLFFBQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLFVBQUEsS0FBSyxFQUFJO3lCQUNKLFdBL0lyQyxZQUFZLEVBK0lzQyxLQUFLLENBQUM7O1NBQXBELFFBQVEsaUJBQVIsUUFBUTtTQUFFLFFBQVEsaUJBQVIsUUFBUTtTQUFFLFNBQVMsaUJBQVQsU0FBUzs7QUFDcEMsWUFBTyxRQUFRLEtBQUssVUFBVSxJQUFJLFFBQVEsS0FBSyxJQUFJLElBQUksU0FBUyxLQUFLLFFBQVEsQ0FBQTtLQUM3RSxDQUFDLENBQUE7QUFDRix5QkFBQSxJQUFJLENBQUMsVUFBVSxFQUFDLE1BQU0sTUFBQSxxQkFBQyxDQUFDLEVBQUUsQ0FBQyw0QkFBSyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsUUFsSi9CLFlBQVksQ0FrSmlDLEdBQUMsQ0FBQTtJQUNoRTtBQUNELE9BQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFOzs7QUFDNUIsUUFBSSxJQUFJLFlBQUEsQ0FBQTtBQUNSLFdBQU8sSUFBSSxFQUFFO0FBQ1osU0FBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUE7OzBCQUNZLFdBeEpyQyxZQUFZLEVBd0pzQyxJQUFJLENBQUM7O1NBQW5ELFFBQVEsa0JBQVIsUUFBUTtTQUFFLFFBQVEsa0JBQVIsUUFBUTtTQUFFLFNBQVMsa0JBQVQsU0FBUzs7QUFDcEMsU0FBSSxFQUFFLFFBQVEsS0FBSyxVQUFVLElBQUksUUFBUSxLQUFLLElBQUksSUFBSSxTQUFTLEtBQUssT0FBTyxDQUFBLEFBQUMsRUFBRSxNQUFLO0tBQ25GO0FBQ0QseUJBQUEsSUFBSSxDQUFDLFVBQVUsRUFBQyxJQUFJLE1BQUEscUJBQUMsSUFBSSw0QkFBSyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsUUEzSjVCLFlBQVksQ0EySjhCLEdBQUMsQ0FBQTtJQUM3RDtBQUNELFVBQU8sS0FBSyxDQUFBO0dBQ1o7RUFFRCxDQUFDLENBQUE7QUFDRixLQUFJLGVBQWUsRUFBRTs7O0FBQ3BCLGlDQUFBLGVBQWUsQ0FBQyxVQUFVLEVBQUMsTUFBTSxNQUFBLCtCQUFDLENBQUMsRUFBRSxRQUFRLDRCQUFLLE1BQU0sQ0FBQyxHQUFHLFFBbEt4QyxZQUFZLENBa0swQyxHQUFDLENBQUE7QUFDM0UsT0FBSyxDQUFDLDRCQUE0QixFQUNqQyxNQUFNLEVBQ04sZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0VBQzVCOztBQUVELFFBQU8sR0FBRyxDQUFBO0NBQ1Y7O0FBRUQsU0FBUyxlQUFlLENBQUMsUUFBUSxFQUFFO0FBQ2xDLFFBQU8sVUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFLO01BQ2pCLE9BQU8sR0FBa0IsTUFBTSxDQUEvQixPQUFPO01BQUUsTUFBTSxHQUFVLE1BQU0sQ0FBdEIsTUFBTTtNQUFFLElBQUksR0FBSSxNQUFNLENBQWQsSUFBSTs7QUFDNUIsTUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFVBQVUsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBLEtBQzFFO0FBQ0osV0FBUSxJQUFJLENBQUMsU0FBUztBQUNyQixTQUFLLFFBQVE7QUFBRSxZQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEFBQUMsTUFBSztBQUFBLEFBQ3hDLFNBQUssT0FBTztBQUFFLFdBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQUFBQyxNQUFLO0FBQUEsQUFDdEM7QUFBUyxXQUFNLENBQUMsT0FBTyxHQUFHLElBQUk7QUFBQSxNQUFBLENBQzlCO0dBQ0Q7QUFDRCxTQUFPLE1BQU0sQ0FBQTtFQUNiLENBQUE7Q0FDRCIsImZpbGUiOiJ0cmFuc2Zvcm0uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRGVidWcgZnJvbSAnZGVidWcnXG5jb25zdCBkZWJ1ZyA9IERlYnVnKCd0cmFuc2Zvcm0nKVxuXG5pbXBvcnQge3R1cGxlMnJlY29yZCwgcmVjb3JkMnR1cGxlLCB0cmF2ZXJzZSwgcmVzb2x2ZSwgcXVlcnl9IGZyb20gJy4vdXRpbDInXG5mdW5jdGlvbiB0cmFuc2Zvcm1JbXBvcnQoZG9jdW1lbnQpIHtcblx0cmV0dXJuIGRvY3VtZW50Ojp0cmF2ZXJzZShub2RlID0+IHtcblx0XHRjb25zdCB7bm9kZVR5cGUsIHBvc2l0aW9uOiBbcGF0aF19ID0gbm9kZVxuXHRcdGlmIChub2RlVHlwZSAhPT0gJ2RvY3VtZW50JykgdGhyb3cgbmV3IEVycm9yKClcblx0XHRub2RlLmNoaWxkTm9kZXMgPSBub2RlLmNoaWxkTm9kZXM6OnRyYXZlcnNlKCh7bm9kZVR5cGUsIHBvc2l0aW9ufSkgPT4ge1xuXHRcdFx0aWYgKG5vZGVUeXBlICE9PSAnc2tpcCcgJiYgcG9zaXRpb24ubGVuZ3RoID09PSAyKSBwb3NpdGlvbi51bnNoaWZ0KHBhdGgpXG5cdFx0fSwgdW5kZWZpbmVkLCB0cnVlKVxuXHRcdHJldHVybiBmYWxzZVxuXHR9KTo6dHJhdmVyc2Uobm9kZSA9PiB7XG5cdFx0Y29uc3Qge25vZGVUeXBlLCBwb3NpdGlvbjogW3BhdGhdLCBub2RlTmFtZSwgbm9kZVZhbHVlLCBjaGlsZE5vZGVzfSA9IG5vZGVcblx0XHRpZiAobm9kZVR5cGUgPT09ICdpbnN0cnVjdGlvbicgJiYgbm9kZU5hbWUgPT09ICdpbXBvcnQnKSB7XG5cdFx0XHRsZXQgdHJlZSA9IGxvYWRUcmVlKHJlc29sdmUobm9kZVZhbHVlLCBwYXRoKSlcblx0XHRcdHRyZWUgPSBvdmVycmlkZSh0cmVlLCBjaGlsZE5vZGVzKVxuXHRcdFx0T2JqZWN0LmFzc2lnbihub2RlLCB0cmVlKVxuXHRcdH1cblx0fSwgJ3Bvc3QnKVxufVxuXG5mdW5jdGlvbiBzb3J0Tm9kZXModHJlZSkge1xuXHRyZXR1cm4gdHJlZTo6dHJhdmVyc2Uobm9kZSA9PiB7XG5cdFx0aWYgKG5vZGUuY2hpbGROb2Rlcykge1xuXHRcdFx0Y29uc3QgYXR0cmlidXRlcyA9IFtdLCBtYWNyb3MgPSBbXSwgbm9ybWFsTm9kZXMgPSBbXVxuXHRcdFx0bGV0IHNraXBzID0gW11cblx0XHRcdGNvbnN0IGZsdXNoID0gdG8gPT4ge1xuXHRcdFx0XHRpZiAoc2tpcHMubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdHRvLnB1c2goLi4uc2tpcHMpXG5cdFx0XHRcdFx0c2tpcHMgPSBbXVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRub2RlLmNoaWxkTm9kZXM6OnRyYXZlcnNlKG5vZGUgPT4ge1xuXHRcdFx0XHRzd2l0Y2ggKG5vZGUubm9kZVR5cGUpIHtcblx0XHRcdFx0XHRjYXNlICdza2lwJzpcblx0XHRcdFx0XHRjYXNlICdzdXBwcmVzcyc6XG5cdFx0XHRcdFx0Y2FzZSAnaW5qZWN0Jzpcblx0XHRcdFx0XHRcdHNraXBzLnB1c2gobm9kZSlcblx0XHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdFx0Y2FzZSAnYXR0cmlidXRlJzpcblx0XHRcdFx0XHRcdGZsdXNoKGF0dHJpYnV0ZXMpXG5cdFx0XHRcdFx0XHRhdHRyaWJ1dGVzLnB1c2gobm9kZSlcblx0XHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdFx0Y2FzZSAnbWFjcm8nOlxuXHRcdFx0XHRcdFx0Zmx1c2gobWFjcm9zKVxuXHRcdFx0XHRcdFx0bWFjcm9zLnB1c2gobm9kZSlcblx0XHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0XHRcdGZsdXNoKG5vcm1hbE5vZGVzKVxuXHRcdFx0XHRcdFx0bm9ybWFsTm9kZXMucHVzaChub2RlKVxuXHRcdFx0XHRcdFx0YnJlYWtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gZmFsc2Vcblx0XHRcdH0sIHVuZGVmaW5lZCwgdHJ1ZSlcblx0XHRcdGZsdXNoKG5vcm1hbE5vZGVzKVxuXHRcdFx0Y29uc3Qgc29ydGVkID0gbWFjcm9zLmNvbmNhdChub3JtYWxOb2Rlcylcblx0XHRcdGlmIChub2RlLm5vZGVUeXBlID09PSAnZWxlbWVudCcgfHwgbm9kZS5ub2RlVHlwZSA9PT0gJ21hY3JvJykge1xuXHRcdFx0XHRzb3J0ZWQudW5zaGlmdCguLi5hdHRyaWJ1dGVzLCB7bm9kZVR5cGU6ICdza2lwJywgZGF0YTogWydjbG9zZVN0YXJ0VGFnJ119KVxuXHRcdFx0fSBlbHNlIGlmIChhdHRyaWJ1dGVzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0Y29uc3QgZSA9IG5ldyBFcnJvcignT25seUVsZW1lbnRBbGxvd0F0dHJpYnV0ZScpXG5cdFx0XHRcdGUucG9zaXRpb24gPSBhdHRyaWJ1dGVzWzBdLnBvc2l0aW9uXG5cdFx0XHRcdHRocm93IGVcblx0XHRcdH1cblx0XHRcdG5vZGUuY2hpbGROb2RlcyA9IHNvcnRlZC5tYXAocmVjb3JkMnR1cGxlKVxuXHRcdH1cblx0fSwgJ3Bvc3QnKVxufVxuXG5cbmltcG9ydCB7ZXhpc3RzU3luY30gZnJvbSAnZnMnXG5pbXBvcnQge3BhcnNlRmlsZX0gZnJvbSAnLidcbmZ1bmN0aW9uIGxvYWRUcmVlKG5hbWUpIHtcblx0bGV0IHBhdGgsIGZyYWdcblx0Y29uc3QgaSA9IG5hbWUubGFzdEluZGV4T2YoJyMnKVxuXHRpZiAoaSA+PSAwKSB7XG5cdFx0cGF0aCA9IG5hbWUuc2xpY2UoMCwgaSlcblx0XHRmcmFnID0gbmFtZS5zbGljZShpICsgMSlcblx0fSBlbHNlIHBhdGggPSBuYW1lXG5cblx0aWYgKGV4aXN0c1N5bmMocGF0aCArICcuamVkaScpKSBwYXRoICs9ICcuamVkaSdcblx0bGV0IHRyZWUgPSBwYXJzZUZpbGUocGF0aClcblx0dHJlZSA9IHRyYW5zZm9ybUltcG9ydCh0cmVlKVxuXHRpZiAoIWZyYWcpIHtcblx0XHR0cmVlWzBdID0gJ2ZyYWdtZW50J1xuXHRcdHRyZWVbMl0gPSBuYW1lICsgJyMnXG5cdFx0cmV0dXJuIHRyZWVcblx0fVxuXHR0cmVlID0gdHJlZTo6cXVlcnkoKHtub2RlVHlwZSwgbm9kZU5hbWUsIG5vZGVWYWx1ZSwgaWR9KSA9PlxuXHRcdG5vZGVUeXBlID09PSAnZnJhZ21lbnQnICYmIG5vZGVOYW1lID09PSBmcmFnICYmIG5vZGVWYWx1ZSA9PT0gdW5kZWZpbmVkXG5cdFx0fHwgbm9kZVR5cGUgPT09ICdlbGVtZW50JyAmJiBpZCA9PT0gZnJhZylcblx0aWYgKCF0cmVlKSB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkICcgKyBuYW1lKVxuXHR0cmVlWzJdID0gbmFtZVxuXHRyZXR1cm4gdHJlZVxufVxuXG5pbXBvcnQge2Rpcn0gZnJvbSAnLi91dGlsJ1xuaW1wb3J0IHRyYW5zZm9ybWVyIGZyb20gJy4vdHJhbnNmb3JtZXInXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB0cmFuc2Zvcm0odHJlZSwgc2hvdyA9IFtdKSB7XG5cdGlmIChzaG93WzBdKSBkaXIodHJlZSlcblxuXHRjb25zb2xlLnRpbWUoJ3RyYW5zZm9ybSAxJylcblx0dHJlZSA9IHRyYW5zZm9ybUltcG9ydCh0cmVlKVxuXHRjb25zb2xlLnRpbWVFbmQoJ3RyYW5zZm9ybSAxJylcblx0aWYgKHNob3dbMV0pIGRpcih0cmVlKVxuXG5cdGNvbnNvbGUudGltZSgndHJhbnNmb3JtIDInKVxuXHR0cmVlID0gdHJhbnNmb3JtZXIuU2NyaXB0SUlGRVdyYXBwZXIubWF0Y2godHJlZSwgJ2RvY3VtZW50Jylcblx0Y29uc29sZS50aW1lRW5kKCd0cmFuc2Zvcm0gMicpXG5cdGlmIChzaG93WzJdKSBkaXIodHJlZSlcblxuXHRjb25zb2xlLnRpbWUoJ3RyYW5zZm9ybSAzJylcblx0dHJlZSA9IHNvcnROb2Rlcyh0cmVlKVxuXHRjb25zb2xlLnRpbWVFbmQoJ3RyYW5zZm9ybSAzJylcblx0aWYgKHNob3dbM10pIGRpcih0cmVlKVxuXG5cdHJldHVybiB0cmVlXG59XG5cbmZ1bmN0aW9uIG92ZXJyaWRlKHRlbXBsYXRlLCBibG9ja3MpIHtcblxuXHRibG9ja3MgPSBibG9ja3MubWFwKHR1cGxlMnJlY29yZClcblx0bGV0IGNvbnRlbnRGcmFnbWVudFxuXG5cdGNvbnN0IHRwbCA9IHR1cGxlMnJlY29yZCh0ZW1wbGF0ZSlcblx0dHBsLmNoaWxkTm9kZXM6OnRyYXZlcnNlKG5vZGUgPT4ge1xuXG5cdFx0bGV0IGZyYWdcblx0XHRpZiAobm9kZS5ub2RlVHlwZSA9PT0gJ2ZyYWdtZW50JyAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRmcmFnID0gbm9kZS5ub2RlTmFtZVxuXHRcdH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gJ2VsZW1lbnQnICYmIG5vZGUuaWQpIHtcblx0XHRcdGZyYWcgPSBub2RlLmlkXG5cdFx0fSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAnbWFjcm8nKSB7XG5cdFx0XHRyZXR1cm4gZmFsc2Vcblx0XHR9XG5cdFx0aWYgKGZyYWcpIHtcblx0XHRcdGxldCBmcmFncyA9IHtyZXBsYWNlOiB1bmRlZmluZWQsIGJlZm9yZXM6IFtdLCBhZnRlcnM6IFtdLCByZXN0OiBbXX1cblx0XHRcdGZyYWdzID0gYmxvY2tzLnJlZHVjZShtYXRjaGVzRnJhZ21lbnQoZnJhZyksIGZyYWdzKVxuXHRcdFx0YmxvY2tzID0gZnJhZ3MucmVzdFxuXHRcdFx0aWYgKGZyYWdzLnJlcGxhY2UpIHtcblx0XHRcdFx0bm9kZS5jaGlsZE5vZGVzLnNwbGljZSgwLCBJbmZpbml0eSwgLi4uZnJhZ3MucmVwbGFjZS5jaGlsZE5vZGVzKVxuXHRcdFx0fSBlbHNlIGlmIChmcmFnID09PSAnY29udGVudCcpIHtcblx0XHRcdFx0Y29udGVudEZyYWdtZW50ID0gbm9kZVxuXHRcdFx0fVxuXHRcdFx0aWYgKGZyYWdzLmJlZm9yZXMubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRjb25zdCBpID0gbm9kZS5jaGlsZE5vZGVzLmZpbmRJbmRleChjaGlsZCA9PiB7XG5cdFx0XHRcdFx0Y29uc3Qge25vZGVUeXBlLCBub2RlTmFtZSwgbm9kZVZhbHVlfSA9IHR1cGxlMnJlY29yZChjaGlsZClcblx0XHRcdFx0XHRyZXR1cm4gbm9kZVR5cGUgIT09ICdmcmFnbWVudCcgfHwgbm9kZU5hbWUgIT09IGZyYWcgfHwgbm9kZVZhbHVlICE9PSAnYmVmb3JlJ1xuXHRcdFx0XHR9KVxuXHRcdFx0XHRub2RlLmNoaWxkTm9kZXMuc3BsaWNlKDAsIGksIC4uLmZyYWdzLmJlZm9yZXMubWFwKHJlY29yZDJ0dXBsZSkpXG5cdFx0XHR9XG5cdFx0XHRpZiAoZnJhZ3MuYWZ0ZXJzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0bGV0IGxhc3Rcblx0XHRcdFx0d2hpbGUgKHRydWUpIHtcblx0XHRcdFx0XHRsYXN0ID0gbm9kZS5jaGlsZE5vZGVzLnBvcCgpXG5cdFx0XHRcdFx0Y29uc3Qge25vZGVUeXBlLCBub2RlTmFtZSwgbm9kZVZhbHVlfSA9IHR1cGxlMnJlY29yZChsYXN0KVxuXHRcdFx0XHRcdGlmICghKG5vZGVUeXBlID09PSAnZnJhZ21lbnQnICYmIG5vZGVOYW1lID09PSBmcmFnICYmIG5vZGVWYWx1ZSA9PT0gJ2FmdGVyJykpIGJyZWFrXG5cdFx0XHRcdH1cblx0XHRcdFx0bm9kZS5jaGlsZE5vZGVzLnB1c2gobGFzdCwgLi4uZnJhZ3MuYWZ0ZXJzLm1hcChyZWNvcmQydHVwbGUpKVxuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGZhbHNlXG5cdFx0fVxuXG5cdH0pXG5cdGlmIChjb250ZW50RnJhZ21lbnQpIHtcblx0XHRjb250ZW50RnJhZ21lbnQuY2hpbGROb2Rlcy5zcGxpY2UoMCwgSW5maW5pdHksIC4uLmJsb2Nrcy5tYXAocmVjb3JkMnR1cGxlKSlcblx0XHRkZWJ1ZygncmVwbGFjZSBkZWZhdWx0IGNvbnRlbnQgdG8nLFxuXHRcdFx0YmxvY2tzLFxuXHRcdFx0Y29udGVudEZyYWdtZW50LmNoaWxkTm9kZXMpXG5cdH1cblxuXHRyZXR1cm4gdHBsXG59XG5cbmZ1bmN0aW9uIG1hdGNoZXNGcmFnbWVudChmcmFnTmFtZSkge1xuXHRyZXR1cm4gKHJlc3VsdCwgbm9kZSkgPT4ge1xuXHRcdGNvbnN0IHtiZWZvcmVzLCBhZnRlcnMsIHJlc3R9ID0gcmVzdWx0XG5cdFx0aWYgKG5vZGUubm9kZVR5cGUgIT09ICdmcmFnbWVudCcgfHwgbm9kZS5ub2RlTmFtZSAhPT0gZnJhZ05hbWUpIHJlc3QucHVzaChub2RlKVxuXHRcdGVsc2Uge1xuXHRcdFx0c3dpdGNoIChub2RlLm5vZGVWYWx1ZSkge1xuXHRcdFx0XHRjYXNlICdiZWZvcmUnOiBiZWZvcmVzLnB1c2gobm9kZSk7IGJyZWFrXG5cdFx0XHRcdGNhc2UgJ2FmdGVyJzogYWZ0ZXJzLnB1c2gobm9kZSk7IGJyZWFrXG5cdFx0XHRcdGRlZmF1bHQ6IHJlc3VsdC5yZXBsYWNlID0gbm9kZSAvL1RPRE86IHRocm93IGVycm9yIGlmIG11bHRpcGxlIHJlcGxhY2VtZW50XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHRcblx0fVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9